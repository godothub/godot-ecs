## 5. API 参考手册

### 1. 核心类 (Core)

#### `ECSWorld`

*继承自 `RefCounted`*
世界容器，管理所有的实体、组件池、系统和调度器。

**属性:**

* `debug_print: bool`: 开启控制台详细操作日志。
* `debug_entity: bool`: 开启后创建 `DebugEntity` 实例（方便断点查看组件），默认为 false。

**方法:**

| 方法名                                                 | 描述                              |
|:--------------------------------------------------- |:------------------------------- |
| **Entity 管理**                                       |                                 |
| `create_entity(id: int = 0) -> ECSEntity`           | 创建新实体。若 `id` 为 0 则自动分配。         |
| `remove_entity(id: int) -> bool`                    | 销毁实体及其所有组件。                     |
| `has_entity(id: int) -> bool`                       | 检查实体是否存在。                       |
| `get_entity(id: int) -> ECSEntity`                  | 获取实体对象包装器。                      |
| **Component 管理**                                    |                                 |
| `add_component(entity_id, name, component) -> bool` | 给实体添加组件实例。                      |
| `remove_component(entity_id, name) -> bool`         | 移除指定组件。                         |
| `get_component(entity_id, name) -> ECSComponent`    | 获取组件实例。                         |
| `has_component(entity_id, name) -> bool`            | 检查实体是否拥有组件。                     |
| **查询 (Query)**                                      |                                 |
| `view(name: StringName) -> Array`                   | 获取指定类型的所有组件实例列表。                |
| `multi_view(names: Array) -> Array`                 | 获取同时拥有多个组件的实体列表（带缓存）。           |
| `query() -> Querier`                                | 创建一个高级查询器实例。                    |
| **System 管理 (单线程)**                                 |                                 |
| `add_system(name, system) -> bool`                  | 注册一个单线程 `ECSSystem`（已弃用，推荐使用 ECSRunner）。 |
| `remove_system(name) -> bool`                       | 移除系统。                           |
| `update(delta: float) -> void`                      | 驱动所有单线程系统更新，并发出 `on_update` 信号（已弃用，推荐使用 ECSRunner）。 |
| **Runner 管理**                                        |                                 |
| `create_runner(name: StringName) -> ECSRunner`     | 创建命名的执行器实例。                   |
| `destroy_runner(name: StringName) -> bool`       | 销毁指定执行器。                      |
| `get_runner(name: StringName) -> ECSRunner`      | 获取执行器实例。                     |
| `remove_all_runners() -> void`                     | 移除所有执行器。                     |
| **Event 管理**                                        |                                 |
| `notify(event_name, value=null)`                    | 广播简单事件。                         |
| `add_callable(name, callback)`                      | 监听事件。                           |
| **调度器**                                             |                                 |
| `create_scheduler(name) -> ECSScheduler`            | 创建并行调度器。                        |

---

#### `ECSEntity`

*继承自 `RefCounted`*
实体的轻量级包装器。本质上只是一个 `id` 和 `world` 的引用。

**方法:**

* `id() -> int`: 获取实体 ID。
* `valid() -> bool`: 检查实体是否依然存活。
* `destroy() -> void`: 销毁自身。
* `add_component(name, comp) -> bool`: 快捷添加组件。
* `get_component(name) -> ECSComponent`: 快捷获取组件。

---

### 2. 组件系统 (Components)

#### `ECSComponent`

*继承自 `Serializer`*
所有组件的基类。

**方法 (需重写以支持序列化):**

* `_on_pack(ar: Archive)`: 写入数据。
* `_on_unpack(ar: Archive)`: 读取数据。
* `_on_convert(ar: Archive)`: 版本升级数据迁移。

#### `ECSDataComponent`

*继承自 `ECSComponent`*
**属性:**

* `data: Variant`: 通用数据容器。
* `on_data_changed(sender, data)`: 信号。

#### `ECSViewComponent`

*继承自 `ECSComponent`*
**属性:**

* `view: Node`: 存储 Godot 场景节点的引用。

---

### 3. 系统与调度 (Systems & Scheduler)

#### `ECSSystem` (直接模式)

*继承自 `Node`*
单线程、有状态的系统基类。

**生命周期:**

* `_on_enter(world)`: 系统被加入世界时。
* `_on_update(delta)`: 每帧更新时。
* `_on_exit(world)`: 系统被移除时。

---

#### `ECSParallel` (调度模式)

*继承自 `RefCounted`*
并行、无状态系统的基类。

**配置方法 (需重写):**

* `_list_components() -> Dictionary`: 定义读写权限。
  * 键: 组件名 (`StringName`)
  * 值: `ECSParallel.READ_ONLY` 或 `ECSParallel.READ_WRITE`
* `_parallel() -> bool`: 是否开启内部多线程拆分。
* `_view_components(view: Dictionary, cmds: Commands)`: 核心逻辑回调。

**依赖配置 (在初始化时调用):**

* `before(systems: Array)`: 在指定系统列表**之前**运行。
* `after(systems: Array)`: 在指定系统列表**之后**运行。
* `in_set(group_id: int)`: 设置分组 ID。

---

#### `ECSRunner` (单线程执行器)

*继承自 `RefCounted`*
单线程系统顺序执行器，提供类似 ECSScheduler 的系统分组管理功能，但不支持并行执行。

**方法:**

| 方法名                                           | 描述                              |
|:----------------------------------------------- |:------------------------------- |
| **Runner 管理**                                  |                                 |
| `create_runner(name: StringName) -> ECSRunner`     | 创建命名的执行器实例。                   |
| `destroy_runner(name: StringName) -> bool`       | 销毁指定执行器。                      |
| `get_runner(name: StringName) -> ECSRunner`      | 获取执行器实例。                     |
| **系统管理**                                    |                                 |
| `add_system(name, system) -> ECSRunner`           | 向执行器添加系统（链式调用）。            |
| `add_systems(systems: Dictionary) -> ECSRunner`   | 批量添加系统（链式调用）。              |
| `remove_system(name: StringName) -> bool`         | 移除指定系统。                       |
| `get_system(name: StringName) -> ECSSystem`       | 获取系统实例。                      |
| **更新控制**                                    |                                 |
| `run(delta: float) -> void`                      | 执行一轮系统更新。                    |
| `set_system_update(name, enable: bool) -> void`  | 启用/禁用单个系统更新。                |
| `set_systems_update(enable: bool) -> void`       | 启用/禁用所有系统更新。                |

---

#### `ECSScheduler` 

*继承自 `RefCounted`*
调度管线管理器。

**方法:**

* `add_systems(systems: Array)`: 批量添加 `ECSParallel` 实例。
* `build()`: 分析依赖图，构建执行计划。
* `run(delta: float)`: 执行一次完整调度（含指令 Flush）。

---

#### `ECSSchedulerCommands` (Commands)

*内部类，通常作为参数传入*
线程安全的延迟操作指令集。

**方法 (流式调用):**

* `spawn() -> Spawner`: 创建新实体。
  * `.add_component(name, comp)`
* `entity(id: int) -> EntityCommands`: 操作现有实体。
  * `.add_component(name, comp)`
  * `.remove_component(name)`
  * `.destroy()`
* `notify(name, value)`: 延迟广播事件。
* `defer(callable)`: 在主线程执行回调。

---

### 4. 工具类 (Utils)

#### `Querier`

高级查询构建器。

**方法:**

* `with(names: Array)`: 必须包含所有列出的组件 (AND)。
* `without(names: Array)`: 不能包含列出的组件 (NOT)。
* `any_of(names: Array)`: 包含任意一个组件即可 (OR)。
* `filter(predicate: Callable)`: 自定义过滤函数 `func(data) -> bool`。
* `exec() -> Array`: 执行查询并返回结果。

#### `ECSWorldPacker`

世界序列化工具。

**方法:**

* `with_factory(factory)`: 注入对象工厂。
* `pack() -> DataPack`: 打包当前世界。
* `unpack(pack: DataPack) -> bool`: 恢复数据到世界。

#### `ObjectFactory`

序列化辅助类，处理脚本类映射。

**方法:**

* `register(script, init_params=[])`: 注册组件类。
